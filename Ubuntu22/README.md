# Ansible Kubernetes Cluster Setup

–≠—Ç–æ—Ç —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —Å–æ–¥–µ—Ä–∂–∏—Ç Ansible-–ø–ª–µ–π–±—É–∫–∏ –∏ —Ä–æ–ª–∏ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è Kubernetes-–∫–ª–∞—Å—Ç–µ—Ä–∞.

## üì¶ –°–æ—Å—Ç–∞–≤

–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Å–Ω–æ–≤–∞–Ω–∞ –Ω–∞ —Ä–æ–ª—è—Ö –∏ –≥—Ä—É–ø–ø–∞—Ö —Ö–æ—Å—Ç–æ–≤ (`group_vars`). –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –º–æ–¥—É–ª—å–Ω–æ–µ —Ä–∞–∑–±–∏–µ–Ω–∏–µ:

```
‚îú‚îÄ‚îÄ ansible.cfg
‚îú‚îÄ‚îÄ inventory/
‚îÇ   ‚îî‚îÄ‚îÄ hosts
‚îú‚îÄ‚îÄ group_vars/
‚îÇ   ‚îú‚îÄ‚îÄ all.yml
‚îÇ   ‚îú‚îÄ‚îÄ Kuber_control.yml
‚îÇ   ‚îî‚îÄ‚îÄ Kuber_working.yml
‚îú‚îÄ‚îÄ site.yml
‚îú‚îÄ‚îÄ roles/
‚îÇ   ‚îú‚îÄ‚îÄ containerd/
‚îÇ   ‚îú‚îÄ‚îÄ k8s_prereqs/
‚îÇ   ‚îú‚îÄ‚îÄ kubernetes_packages/
‚îÇ   ‚îú‚îÄ‚îÄ kubeadm_init/
‚îÇ   ‚îú‚îÄ‚îÄ kube_join_master/
‚îÇ   ‚îú‚îÄ‚îÄ kube_join_worker/
‚îÇ   ‚îú‚îÄ‚îÄ certs/
‚îÇ   ‚îú‚îÄ‚îÄ keepalived/
‚îÇ   ‚îú‚îÄ‚îÄ join_commands/
‚îÇ   ‚îú‚îÄ‚îÄ reboot/
‚îÇ   ‚îî‚îÄ‚îÄ admin_conf/
‚îî‚îÄ‚îÄ .gitignore
```

## üõ†Ô∏è –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

* –£—Å—Ç–∞–Ω–æ–≤–∫–∞ `containerd` –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ cgroup'–æ–≤
* –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ (`sysctl`, `br_netfilter`)
* –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Kubernetes-–ø–∞–∫–µ—Ç–æ–≤ (`kubeadm`, `kubelet`, `kubectl`)
* –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–∞—Å—Ç–µ—Ä-–Ω–æ–¥—ã (`kubeadm init`)
* –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –¥—Ä—É–≥–∏—Ö master –∏ worker –Ω–æ–¥ –∫ –∫–ª–∞—Å—Ç–µ—Ä—É
* –†–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ `Weave CNI`
* –ù–∞—Å—Ç—Ä–æ–π–∫–∞ `keepalived` —Å –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–º IP
* –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∏ –ø–µ—Ä–µ–¥–∞—á–∞ `join-command`
* –õ–æ–∫–∞–ª—å–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ `admin.conf` –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–ª–∞—Å—Ç–µ—Ä—É

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

1. –°–∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä—É–π `inventory/hosts` –∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ `group_vars/`
2. –ó–∞–ø—É—Å—Ç–∏ playbook:

```bash
ansible-playbook -i inventory/hosts site.yml
```

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

> ‚ö†Ô∏è –£–±–µ–¥–∏—Å—å, —á—Ç–æ —Ñ–∞–π–ª—ã `pki/`, `vault.yml`, `join-command`, `admin.conf` –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ `.gitignore`.

## üìò –ü—Ä–∏–º–µ—Ä—ã

–§–∞–π–ª `site.yml` —Å–æ–¥–µ—Ä–∂–∏—Ç –æ—Å–Ω–æ–≤–Ω—É—é —Ç–æ—á–∫—É –≤—Ö–æ–¥–∞ –∏ –∑–∞–¥–∞—ë—Ç –ø–æ—Ä—è–¥–æ–∫ —Ä–æ–ª–µ–π:

```yaml
- hosts: Kuber_control
  become: true
  roles:
    - containerd
    - k8s_prereqs
    - kubernetes_packages
    - reboot
    - keepalived
    ...

- hosts: Kuber_working
  become: true
  roles:
    - containerd
    - kube_join_worker
    ...
```

## üß© –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ

* `master_playbook.yml`, `test.yml`, `random_uuid` ‚Äî –≤—Ä–µ–º–µ–Ω–Ω—ã–µ/–≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã
* –ò—Å–ø–æ–ª—å–∑—É–π `--tags` –∏ `--start-at-task` –¥–ª—è —Ç–æ—á–µ—á–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞

## üìÑ –õ–∏—Ü–µ–Ω–∑–∏—è

MIT

